name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: btouchard/ackify-ce

jobs:
  # Phase 1: Tests parallÃ¨les
  backend-tests:
    name: Backend Tests
    uses: ./.github/workflows/test-backend.yml
    secrets: inherit

  frontend-tests:
    name: Frontend Tests
    uses: ./.github/workflows/test-frontend.yml
    secrets: inherit

  e2e-tests:
    name: E2E Tests
    uses: ./.github/workflows/test-e2e.yml
    secrets: inherit
    needs: [backend-tests, frontend-tests]

  # Phase 2: Coverage global
  coverage-report:
    name: Coverage Report
    uses: ./.github/workflows/coverage-report.yml
    needs: [backend-tests, frontend-tests, e2e-tests]
    secrets: inherit
    if: always()

  # Phase 3: Build & Deploy (seulement si tests OK + pas PR)
  build-and-push:
    name: Build and Push Docker
    if: github.event_name != 'pull_request'
    uses: ./.github/workflows/build-docker.yml
    needs: [backend-tests, frontend-tests, e2e-tests]
    secrets: inherit
    with:
      push: true

  # Phase 4: Security scan
  security-scan:
    name: Security Scan
    if: github.event_name != 'pull_request'
    uses: ./.github/workflows/security.yml
    needs: build-and-push
    secrets: inherit

  # Notification finale
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, build-and-push, security-scan]
    if: always() && github.event_name != 'pull_request'

    steps:
    - name: Compute IMAGE_TAG
      run: echo "IMAGE_TAG=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

    - name: Notify success
      if: needs.backend-tests.result == 'success' && needs.frontend-tests.result == 'success' && needs.e2e-tests.result == 'success' && needs.build-and-push.result == 'success'
      run: |
        echo "âœ… CI/CD Pipeline completed successfully!"
        echo "ğŸš€ Image pushed: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

    - name: Notify failure
      if: needs.backend-tests.result == 'failure' || needs.frontend-tests.result == 'failure' || needs.e2e-tests.result == 'failure' || needs.build-and-push.result == 'failure'
      run: |
        echo "âŒ CI/CD Pipeline failed!"
        echo "Please check the logs above for details."
        exit 1
